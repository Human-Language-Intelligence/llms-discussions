{% extends 'base.html' %}
{% block content %}
<main class="result-section">
  <header class="page-header">
    <h1>ğŸ“Š í† ë¡  í‰ê°€ ê²°ê³¼</h1>
    <span id="winner-badge" class="winner-badge hidden">ìš°ìŠ¹: <strong></strong></span>
  </header>

  <section class="score-card">
    <h2>ğŸ§‘â€âš–ï¸ LLM Judge í‰ê°€ (ì„¤ë“ë ¥)</h2>
    <div class="judge-structured">
      <div class="judge-kpis">
        <div class="kv">
          <span class="k-label">GPT</span>
          <strong id="judge-gpt" class="k-value">--</strong>
        </div>
        <div class="kv">
          <span class="k-label">GEMINI</span>
          <strong id="judge-gemini" class="k-value">--</strong>
        </div>
        <div class="kv winner">
          <span class="k-label">Winner</span>
          <strong id="judge-winner" class="k-value">--</strong>
        </div>
      </div>

      <div class="judge-desc">
        <div class="desc-title">ì„¤ëª…</div>
        <p id="judge-desc" class="judge-raw"></p>
      </div>

      <!-- ìˆ¨ê¹€: ì›ë³¸ ë¬¸ìì—´(íŒŒì‹± ì‹¤íŒ¨ ì‹œ fallback ìš©) -->
      <pre id="judge-raw" class="hidden">{{ result.judge_result }}</pre>
    </div>
  </section>

  <div class="grid">
    <section class="score-card">
      <h3>ğŸ§  Coherence Flow Score (ì¼ê´€ì„±)</h3>

      {% set coh_gpt = (result.coherence.gpt * 100) | round(1) %}
      {% set coh_gem = (result.coherence.gemini * 100) | round(1) %}

      <div class="kpi" id="coh-gpt">
        <div class="kpi-row">
          <span class="label">GPT</span>
          <span class="value">{{ "%.4f"|format(result.coherence.gpt) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill" style="width: {{ coh_gpt }}%;"></div>
        </div>
      </div>

      <div class="kpi" id="coh-gem">
        <div class="kpi-row">
          <span class="label">GEMINI</span>
          <span class="value">{{ "%.4f"|format(result.coherence.gemini) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill alt" style="width: {{ coh_gem }}%;"></div>
        </div>
      </div>
    </section>

    <section class="score-card">
      <h3>ğŸ§¾ Argument Diversity Index (ë‹¤ì–‘ì„±)</h3>

      {% set div_gpt = (result.diversity.gpt * 100) | round(1) %}
      {% set div_gem = (result.diversity.gemini * 100) | round(1) %}

      <div class="kpi" id="div-gpt">
        <div class="kpi-row">
          <span class="label">GPT</span>
          <span class="value">{{ "%.4f"|format(result.diversity.gpt) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill" style="width: {{ div_gpt }}%;"></div>
        </div>
      </div>

      <div class="kpi" id="div-gem">
        <div class="kpi-row">
          <span class="label">GEMINI</span>
          <span class="value">{{ "%.4f"|format(result.diversity.gemini) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill alt" style="width: {{ div_gem }}%;"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="actions">
    <a href="{{ url_for('home') }}" class="btn">â† ëŒì•„ê°€ê¸°</a>
  </div>
</main>

<script>
  (function () {
    // ì›ë³¸ judge ë¬¸ìì—´
    const rawEl = document.getElementById('judge-raw');
    const raw = rawEl?.textContent?.trim() || '';

    // íƒ€ê¹ƒ ì—˜ë¦¬ë¨¼íŠ¸
    const gptEl = document.getElementById('judge-gpt');
    const gemEl = document.getElementById('judge-gemini');
    const winEl = document.getElementById('judge-winner');
    const descEl = document.getElementById('judge-desc');
    const badge = document.getElementById('winner-badge');

    // 1) ì ìˆ˜/ìš°ìŠ¹ì íŒŒì‹± (ì—¬ëŸ¬ í¬ë§· í—ˆìš©)
    const headerRe = /GPT\s*:\s*\[\[?(\d+(?:\.\d+)?)\]?\]\s*[,;]?\s*GEMINI\s*:\s*\[\[?(\d+(?:\.\d+)?)\]?\]\s*[,;]?\s*winner\s*:\s*\[\[?([\wê°€-í£]+)\]?\]/i;
    const m = raw.match(headerRe);

    if (m) {
      const gpt = m[1], gem = m[2], winner = (m[3] || '').toUpperCase();
      if (gptEl) gptEl.textContent = gpt;
      if (gemEl) gemEl.textContent = gem;
      if (winEl) winEl.textContent = winner;

      // 2) ì„¤ëª… ë¶€ë¶„ ì¶”ì¶œ (í—¤ë” ì œê±° í›„ ë‚¨ëŠ” í…ìŠ¤íŠ¸)
      let desc = raw.slice(m.index + m[0].length).trim();
      // ì„ í–‰ êµ¬ë‘ì /ë¶ˆí•„ìš” ë¬¸ì ì œê±°
      desc = desc.replace(/^[\s:.,\-â€“â€”]+/, '');
      if (!desc) desc = raw;  // ì•ˆì „ì¥ì¹˜
      if (descEl) descEl.textContent = desc;

      // 3) Winner ë°°ì§€/í•˜ì´ë¼ì´íŠ¸
      if (badge && winner) {
        badge.querySelector('strong').textContent = winner;
        badge.classList.remove('hidden');
        const winnerId = (winner === 'GPT') ? '#coh-gpt, #div-gpt' : '#coh-gem, #div-gem';
        document.querySelectorAll(winnerId).forEach(el => el.classList.add('winner'));
      }
    } else {
      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ: ì›ë³¸ì„ ì„¤ëª…ì— ê·¸ëŒ€ë¡œ ë…¸ì¶œ
      if (descEl) descEl.textContent = raw;
    }
  })();
</script>

{% endblock %}

{% extends 'base.html' %}
{% block content %}
<main class="result-section">
  <header class="page-header">
    <h1>ğŸ“Š í† ë¡  í‰ê°€ ê²°ê³¼</h1>
    <span id="winner-badge" class="winner-badge hidden">ìš°ìŠ¹: <strong></strong></span>
  </header>

  <section class="score-card">
    <h2>ğŸ§‘â€âš–ï¸ LLM Judge í‰ê°€ (ì„¤ë“ë ¥)</h2>
    <div class="judge-structured">
      <div class="judge-kpis">
        <div class="kv">
          <span class="k-label">GPT</span>
          <strong id="judge-gpt" class="k-value">--</strong>
        </div>
        <div class="kv">
          <span class="k-label">GEMINI</span>
          <strong id="judge-gemini" class="k-value">--</strong>
        </div>
        <div class="kv winner">
          <span class="k-label">Winner</span>
          <strong id="judge-winner" class="k-value">--</strong>
        </div>
      </div>

      <div class="judge-desc">
        <div class="desc-title">ì„¤ëª…</div>
        <p id="judge-desc" class="judge-raw"></p>
      </div>

      <!-- ìˆ¨ê¹€: ì›ë³¸ ë¬¸ìì—´(íŒŒì‹± ì‹¤íŒ¨ ì‹œ fallback ìš©) -->
      <pre id="judge-raw" class="hidden">{{ result.judge_result }}</pre>
    </div>
  </section>

  <div class="grid">
    <section class="score-card">
      <h3>ğŸ§  Coherence Flow Score (ì¼ê´€ì„±)</h3>

      {% set coh_gpt = (result.coherence.gpt * 100) | round(1) %}
      {% set coh_gem = (result.coherence.gemini * 100) | round(1) %}

      <div class="kpi" id="coh-gpt">
        <div class="kpi-row">
          <span class="label">GPT</span>
          <span class="value">{{ "%.4f"|format(result.coherence.gpt) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill" style="width: {{ coh_gpt }}%;"></div>
        </div>
      </div>

      <div class="kpi" id="coh-gem">
        <div class="kpi-row">
          <span class="label">GEMINI</span>
          <span class="value">{{ "%.4f"|format(result.coherence.gemini) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill alt" style="width: {{ coh_gem }}%;"></div>
        </div>
      </div>
    </section>

    <section class="score-card">
      <h3>ğŸ§¾ Argument Diversity Index (ë‹¤ì–‘ì„±)</h3>

      {% set div_gpt = (result.diversity.gpt * 100) | round(1) %}
      {% set div_gem = (result.diversity.gemini * 100) | round(1) %}

      <div class="kpi" id="div-gpt">
        <div class="kpi-row">
          <span class="label">GPT</span>
          <span class="value">{{ "%.4f"|format(result.diversity.gpt) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill" style="width: {{ div_gpt }}%;"></div>
        </div>
      </div>

      <div class="kpi" id="div-gem">
        <div class="kpi-row">
          <span class="label">GEMINI</span>
          <span class="value">{{ "%.4f"|format(result.diversity.gemini) }}</span>
        </div>
        <div class="meter">
          <div class="meter-fill alt" style="width: {{ div_gem }}%;"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="actions">
    <a href="{{ url_for('home') }}" class="btn">â† ëŒì•„ê°€ê¸°</a>
  </div>
</main>

<script>
  (function () {
    // ì›ë³¸ judge ë¬¸ìì—´
    const rawEl = document.getElementById('judge-raw');
    const raw = rawEl?.textContent?.trim() || '';

    // íƒ€ê¹ƒ ì—˜ë¦¬ë¨¼íŠ¸
    const gptEl = document.getElementById('judge-gpt');
    const gemEl = document.getElementById('judge-gemini');
    const winEl = document.getElementById('judge-winner');
    const descEl = document.getElementById('judge-desc');
    const badge = document.getElementById('winner-badge');

    // 1) ì ìˆ˜/ìš°ìŠ¹ì íŒŒì‹±
    const headerRe = /GPT\s*:\s*\[\[?(\d+(?:\.\d+)?)\]?\]\s*[,;]?\s*GEMINI\s*:\s*\[\[?(\d+(?:\.\d+)?)\]?\]\s*[,;]?\s*winner\s*:\s*\[\[?([\wê°€-í£]+)\]?\]/i;
    const m = raw.match(headerRe);

    let judgeGPT = 0, judgeGem = 0, winner = '';

    if (m) {
      judgeGPT = parseFloat(m[1]);
      judgeGem = parseFloat(m[2]);
      winner = (m[3] || '').toUpperCase();

      if (gptEl) gptEl.textContent = judgeGPT.toFixed(2);
      if (gemEl) gemEl.textContent = judgeGem.toFixed(2);
      if (winEl) winEl.textContent = winner;

      // ì„¤ëª… ì¶”ì¶œ
      let desc = raw.slice(m.index + m[0].length).trim();
      desc = desc.replace(/^[\s:.,\-â€“â€”]+/, '');
      if (!desc) desc = raw;
      if (descEl) descEl.textContent = desc;
    } else {
      if (descEl) descEl.textContent = raw;
    }

    // 2) coherence & diversity ìŠ¤ì½”ì–´ ê°€ì ¸ì˜¤ê¸°
    const cohGPT = parseFloat(document.querySelector("#coh-gpt .value")?.textContent || "0");
    const cohGem = parseFloat(document.querySelector("#coh-gem .value")?.textContent || "0");
    const divGPT = parseFloat(document.querySelector("#div-gpt .value")?.textContent || "0");
    const divGem = parseFloat(document.querySelector("#div-gem .value")?.textContent || "0");

    // 3) ìµœì¢… ì ìˆ˜ ê³„ì‚° (2:1:1 ë¹„ìœ¨ â†’ ìµœëŒ€ 22ì  ê¸°ì¤€ í™˜ì‚°)
    const maxScore = 22.0;
    const rawFinalGPT = (judgeGPT * 2) + cohGPT + divGPT;
    const rawFinalGem = (judgeGem * 2) + cohGem + divGem;

    const finalGPT = (rawFinalGPT / maxScore) * 100;
    const finalGem = (rawFinalGem / maxScore) * 100;

    // ê²°ê³¼ë¥¼ ì¶œë ¥
    const finalScoreBox = document.createElement("section");
    finalScoreBox.className = "score-card";
    finalScoreBox.innerHTML = `
      <h3>ğŸ† ìµœì¢… í™˜ì‚° ì ìˆ˜</h3>
      <div class="kpi" id="final-gpt">
        <div class="kpi-row">
          <span class="label">GPT</span>
          <span class="value" title="(${judgeGPT.toFixed(2)}Ã—2 + ${cohGPT.toFixed(4)} + ${divGPT.toFixed(4)}) / 22 Ã— 100">
            ${finalGPT.toFixed(2)} / 100
          </span>
        </div>
        <div class="meter">
          <div class="meter-fill" style="width: ${finalGPT.toFixed(2)}%;"></div>
        </div>
      </div>
      <div class="kpi" id="final-gemini">
        <div class="kpi-row">
          <span class="label">GEMINI</span>
          <span class="value" title="(${judgeGem.toFixed(2)}Ã—2 + ${cohGem.toFixed(4)} + ${divGem.toFixed(4)}) / 22 Ã— 100">
            ${finalGem.toFixed(2)} / 100
          </span>
        </div>
        <div class="meter">
          <div class="meter-fill alt" style="width: ${finalGem.toFixed(2)}%;"></div>
        </div>
      </div>
    `;

    // í™”ë©´ì— ì¶”ê°€
    const grid = document.querySelector(".grid");
    if (grid) {
      grid.insertAdjacentElement("afterend", finalScoreBox);
    }

    // 4) ìš°ìŠ¹ì í‘œì‹œ
    let finalWinner = '';
    if (finalGPT > finalGem) finalWinner = 'GPT';
    else if (finalGem > finalGPT) finalWinner = 'GEMINI';
    else finalWinner = 'ë¬´ìŠ¹ë¶€';

    if (badge && finalWinner) {
      badge.querySelector('strong').textContent = finalWinner;
      badge.classList.remove('hidden');

      const winnerId = finalWinner === 'GPT'
        ? '#coh-gpt, #div-gpt, #final-gpt'
        : finalWinner === 'GEMINI'
          ? '#coh-gem, #div-gem, #final-gemini'
          : '';

      if (winnerId) {
        document.querySelectorAll(winnerId).forEach(el => el.classList.add('winner'));
      }
    }
  })();
</script>

{% endblock %}

{% extends 'base.html' %}
{% block content %}
<main class="main-application">
  <div class="debate-section">
    <section class="debate-status">
      <div class="status-info">
        <h2>í† ë¡  ì£¼ì œ: {{ topic }}</h2>
        <div id="room-container" data-room="{{ code }}" data-topic="{{ topic }}"></div>
      </div>
      <div class="debate-stats">
        <div class="stat-item">
          <div class="stat-number" id="total-messages">0</div>
          <div class="stat-label">ì´ ë°œì–¸</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="debate-ratio">0:0</div>
          <div class="stat-label">ì°¬ì„±:ë°˜ëŒ€</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="debate-time">0m</div>
          <div class="stat-label">ì§„í–‰ì‹œê°„</div>
        </div>
      </div>
    </section>

    <section class="chat-container">
      <div class="chat-header">
        <h2 class="chat-title">ğŸ’¬ ì‹¤ì‹œê°„ í† ë¡ </h2>
        <div class="debate-controls">
          <button class="control-btn active" id="audio-btn">ğŸ”´ ìŒì„±</button>
          <button class="control-btn secondary" id="pause-btn">â¸ï¸ ì¼ì‹œì •ì§€</button>
          <button class="control-btn secondary" id="stats-btn">ğŸ“Š í†µê³„</button>
        </div>
      </div>

      <div class="messages-region" role="log" aria-live="polite">
        <div class="active-messages" id="active-messages">
          <!-- ê° roleë³„ í˜„ì¬ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
          <div class="role-message-container" id="pros-container" data-role="pros"></div>
          <div class="role-message-container" id="user-container" data-role="user"></div>
          <div class="role-message-container" id="cons-container" data-role="cons"></div>
        </div>
      </div>
    </section>

    <section class="input-panel">
      <form class="input-container" onsubmit="sendMessage(event)">
        <textarea id="message-input" class="message-input input" placeholder="í† ë¡ ì— ëŒ€í•œ ì˜ê²¬ì„ ë‚˜ëˆ ë³´ì„¸ìš”..." rows="1"
          maxlength="500"></textarea>
        <button type="submit" class="submit-button btn btn-primary">ğŸ“¤ ì „ì†¡</button>
      </form>
      <div class="input-info">
        <span class="char-count" id="char-count">0/500</span>
        <span class="input-hint">Enterë¡œ ì „ì†¡, Shift+Enterë¡œ ì¤„ë°”ê¿ˆ</span>
      </div>
    </section>
  </div>

  <aside class="history-section">
    <header class="panel-header">
      <h2 class="panel-title">ğŸ“š í† ë¡  íˆìŠ¤í† ë¦¬</h2>
      <p class="panel-description">ì§€ë‚œ ëŒ€í™” ìš”ì•½</p>
      <div class="history-controls">
        <button class="btn btn-secondary" id="export-btn">ğŸ“ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-secondary" id="clear-history-btn">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
      </div>
    </header>

    <div class="history-region">
      <ul class="history-list" id="history-list">
        <!-- íˆìŠ¤í† ë¦¬ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </ul>
      <div class="history-empty" id="history-empty">
        <div class="empty-icon">ğŸ“</div>
        <p>ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
      </div>
    </div>

    <div class="panel-navigation">
      <a href="{{ url_for('home') }}" class="home-link btn btn-primary">
        ğŸ  ìƒˆë¡œìš´ í† ë¡  ì‹œì‘
      </a>
    </div>
  </aside>
</main>

<script type="module">
  import { io } from "https://cdn.socket.io/4.8.1/socket.io.esm.min.js";
  import { createProfileBlock, getUserClass, getRoleLabel, getAvatarPath } from '../static/js/utils.js';

  const socket = io();

  // ì „ì—­ ë³€ìˆ˜
  let debateStats = {
    totalMessages: 0,
    prosMessages: 0,
    consMessages: 0,
    startTime: Date.now()
  };

  let currentData = null;
  let audio = null;
  let audioOn = true;

  // ê° roleë³„ í˜„ì¬ ë©”ì‹œì§€ ì €ì¥
  let currentMessages = {
    pros: null,
    cons: null,
    user: null
  };

  function isAudioPlaying() {
    return audio && !audio.paused && !audio.ended && audio.currentTime > 0;
  }

  // DOM ìš”ì†Œë“¤
  const roomCode = document.getElementById("room-container").getAttribute("data-room");
  const activeMessages = document.getElementById("active-messages");
  const historyContainer = document.getElementById("history-list");
  const messageInput = document.getElementById("message-input");
  const charCount = document.getElementById("char-count");
  const historyEmpty = document.getElementById("history-empty");

  const updateStats = () => {
    document.getElementById("total-messages").textContent = debateStats.totalMessages;
    document.getElementById("debate-ratio").textContent = `${debateStats.prosMessages}:${debateStats.consMessages}`;

    const elapsed = Math.floor((Date.now() - debateStats.startTime) / 60000);
    document.getElementById("debate-time").textContent = `${elapsed}m`;
  };

  const updateHistoryVisibility = () => {
    const hasHistory = historyContainer.children.length > 0;
    historyEmpty.classList.toggle("hidden", hasHistory);
  };

  // roleë³„ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸/ìƒì„± í•¨ìˆ˜
  const updateRoleMessage = ({
    name,
    message,
    timestamp = new Date().toLocaleString(),
    role = "user",
    is_typing = false
  }) => {
    const container = document.getElementById(`${role}-container`);
    if (!container) return;

    const roleLabel = getRoleLabel(role);
    const formattedMessage = message.replace(/\n/g, "<br>");

    // íƒ€ì´í•‘ ì¤‘ì´ë©´ íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
    const typingIndicator = is_typing ? `
      <div class="typing-indicator">
        <span></span><span></span><span></span>
      </div>
    ` : '';

    container.innerHTML = `
      <div class="message-item ${is_typing ? 'typing-message' : ''}" data-role="${role}">
        <div class="message-content">
          <div class="message-header">
            <img src="${getAvatarPath(name, role)}" alt="${name}" class="speaker-avatar">
            <div class="speaker-info">
              <h3 class="speaker-name">${name.toUpperCase()}</h3>
              <span class="speaker-role">${roleLabel}</span>
            </div>
          </div>
          <div class="message-bubble ${is_typing ? 'typing-bubble' : ''}">
            <p class="message-text">${formattedMessage}</p>
            ${typingIndicator}
          </div>
          ${!is_typing ? `<time class="message-timestamp">${timestamp}</time>` : ''}
        </div>
      </div>
    `;

    // ë©”ì‹œì§€ê°€ ì™„ë£Œë˜ë©´ í˜„ì¬ ë©”ì‹œì§€ ì €ì¥
    if (!is_typing && message) {
      currentMessages[role] = {
        name,
        message,
        timestamp,
        role
      };

      // í†µê³„ ì—…ë°ì´íŠ¸
      debateStats.totalMessages++;
      if (role === 'pros') debateStats.prosMessages++;
      if (role === 'cons') debateStats.consMessages++;
      updateStats();
    }
  };

  // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
  const appendToHistory = ({
    data,
    timestamp = new Date().toLocaleString()
  }) => {
    const roleLabel = getRoleLabel(data.role);
    const formattedMessage = data.message.replace(/\n/g, "<br>");

    const historyElement = document.createElement('li');
    historyElement.className = 'history-item';
    historyElement.setAttribute('data-role', data.role);

    historyElement.innerHTML = `
      <div class="history-meta">
        <img src="${getAvatarPath(data.name, data.role)}" alt="${data.name}" class="speaker-avatar">
        <div class="speaker-info">
          <h3 class="speaker-name">${data.name.toUpperCase()}</h3>
          <span class="speaker-role">${roleLabel}</span>
        </div>
      </div>
      <p class="history-message">${formattedMessage}</p>
      <time class="message-timestamp">${timestamp}</time>
    `;

    historyContainer.insertBefore(historyElement, historyContainer.firstChild);
    updateHistoryVisibility();
  };

  // ë©”ì‹œì§€ ì „ì†¡
  const sendMessage = (event) => {
    event.preventDefault();
    const message = messageInput.value.trim();

    if (message && socket) {
      socket.emit("user", { data: message });
      messageInput.value = "";
      updateCharCount();
      messageInput.style.height = 'auto';
    }
  };

  // ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸
  const updateCharCount = () => {
    const count = messageInput.value.length;
    charCount.textContent = `${count}/500`;
    charCount.style.color = count > 400 ? 'var(--error-500)' : 'var(--text-muted)';
  };

  const stopAudio = () => {
    if (audio && isAudioPlaying()) {
      audio.pause();
      audio.currentTime = 0;
    }
  };

  const complete = (data) => {
    appendToHistory({
      data: data,
      timestamp: new Date(data.timestamp).toLocaleString()
    });
    stopAudio();

    if (socket) {
      socket.emit("complete", { role: data.role, room: roomCode });
      console.log(`Complete: ${data.role}, room: ${roomCode}`);
    }
  };

  // ì˜¤ë””ì˜¤ ì¬ìƒ
  const playAudio = (data) => {
    if (!data.audio_base64 || !audioOn) {
      complete(data);
      return;
    }
    const url = "data:audio/ogg;base64," + data.audio_base64;

    audio = new Audio(url);
    audio.onended = () => complete(data);

    stopAudio();
    audio.play().catch(console.error);
  };

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
  document.addEventListener("DOMContentLoaded", () => {
    // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸
    messageInput.addEventListener("input", () => {
      updateCharCount();

      // ìë™ ë†’ì´ ì¡°ì ˆ
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    });

    messageInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage(event);
      }
    });

    // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤
    document.getElementById('audio-btn')?.addEventListener('click', (e) => {
      // ì˜¤ë””ì˜¤ í† ê¸€ ë¡œì§
      audioOn = !audioOn;
      e.target.classList.toggle('active', audioOn);

      if (!audioOn) complete(currentData);
    });

    document.getElementById('pause-btn')?.addEventListener('click', (e) => {
      e.target.classList.toggle('active');
      // ì¼ì‹œì •ì§€ ë¡œì§
    });

    document.getElementById('clear-history-btn')?.addEventListener('click', () => {
      if (confirm('íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        historyContainer.innerHTML = '';
        updateHistoryVisibility();
      }
    });

    document.getElementById('export-btn')?.addEventListener('click', () => {
      // íˆìŠ¤í† ë¦¬ ë‚´ë³´ë‚´ê¸° ë¡œì§
      const historyData = Array.from(historyContainer.children).map(item => ({
        role: item.getAttribute('data-role'),
        name: item.querySelector('.speaker-name').textContent,
        message: item.querySelector('.history-message').textContent,
        timestamp: item.querySelector('.message-timestamp').textContent
      }));

      const blob = new Blob([JSON.stringify(historyData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debate-history-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('stats-btn')?.addEventListener('click', async () => {
      const roomCode = document
        .getElementById("room-container")
        .getAttribute("data-room");
      const topic = document
        .getElementById("room-container")
        .getAttribute("data-topic");

      try {
        const response = await fetch("/evaluate", {
          method: "POST",
          credentials: "same-origin",      // send session cookie
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ room: roomCode, topic })
        });

        // 400/500 â†’ error JSON
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          alert("âŒ í‰ê°€ ì‹¤íŒ¨: " + (err.error || response.status));
          return;
        }

        // 200 â†’ success JSON
        // we don't actually need the body here,
        // since we stored it to session and result.html will read it.
        window.location.href = "/result";

      } catch (err) {
        console.error("Evaluation error:", err);
        alert("âŒ í†µê³„ í‰ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    });

    updateStats();
    updateHistoryVisibility();
  });

  // Socket.IO ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
  if (typeof socket !== 'undefined') {
    socket.on("connect", function () {
      const userTopic = "{{ topic }}";
      socket.emit("start", { topic: userTopic });
    });

    socket.on("message", (data) => {
      updateRoleMessage({
        name: data.name,
        message: data.message,
        role: "user",
        is_typing: data.is_typing || false
      });

      appendToHistory({
        data: data,
        timestamp: new Date(data.timestamp).toLocaleString()
      });
    });

    socket.on("pros-message", (data) => {
      currentData = data;

      updateRoleMessage({
        name: data.name,
        message: data.message,
        role: data.role,
        is_typing: data.is_typing || false
      });

      if (!data.is_typing && data.audio_base64) {
        playAudio(data);
      }
    });

    socket.on("cons-message", (data) => {
      currentData = data;

      updateRoleMessage({
        name: data.name,
        message: data.message,
        role: data.role,
        is_typing: data.is_typing || false
      });

      if (!data.is_typing && data.audio_base64) {
        playAudio(data);
      }
    });

    socket.on("clear-pros-response", () => {
      const container = document.getElementById('pros-container');
      if (container) container.innerHTML = '';
    });

    socket.on("clear-cons-response", () => {
      const container = document.getElementById('cons-container');
      if (container) container.innerHTML = '';
    });
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
  window.sendMessage = sendMessage;

  console.log("Room code:", roomCode);
</script>
{% endblock %}
